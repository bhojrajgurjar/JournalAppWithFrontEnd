<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Your Journal</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<<<<<<< HEAD
  <style>
        .toast {
    visibility: hidden;
    min-width: 250px;
    margin-left: -125px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 8px;
    padding: 16px;
    position: fixed;
    z-index: 1000;
    left: 50%;
    top: 20px;  /* show at top */
    font-size: 16px;
    opacity: 0;
    transition: opacity 0.5s, top 0.5s;
}

.toast.show {
    visibility: visible;
    opacity: 1;
    top: 40px; /* slide down a little when visible */
}

.toast.success {
    background-color: #28a745; /* Green */
}

.toast.error {
    background-color: #dc3545; /* Red */
}
    </style>
=======
>>>>>>> 0ecd5a8 (Initial clean commit)
</head>
<body class="bg-gray-100 font-sans">

<div class="max-w-5xl mx-auto mt-8 p-6 bg-white rounded-lg shadow-md">
  <!-- Header -->
  <div class="flex justify-between items-center border-b pb-4 mb-6">
    <h2 class="text-xl font-semibold text-gray-800">
      Welcome to Your Journal - <span th:text="${username}">Username</span>
    </h2>
    <button onclick="logout()" class="bg-red-500 hover:bg-red-700 text-white px-4 py-2 rounded">
      Logout
    </button>
  </div>

  <!-- Action Buttons -->
  <div class="flex gap-4 mb-6">
    <a th:href="@{/user/add-entry}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
      Add New Entry
    </a>
    <a th:href="@{/user/view-journal}" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">
      View All Entries
    </a>
  </div>

  <!-- Latest Entry Table -->
  <div th:if="${latestEntry != null}">
    <h3 class="text-lg font-semibold text-gray-700 mb-3">Your Latest Journal Entry</h3>

    <table class="table-auto w-full border border-gray-300 rounded shadow text-sm">
      <thead class="bg-gray-200">
      <tr>
        <th class="px-4 py-2 border-b w-1/5 text-left">Title</th>
        <th class="px-4 py-2 border-b w-2/5 text-left">Content</th>
        <th class="px-4 py-2 border-b w-1/5 text-left">Date</th>
        <th class="px-4 py-2 border-b w-1/10 text-center">Edit</th>
        <th class="px-4 py-2 border-b w-1/10 text-center">Delete</th>
      </tr>
      </thead>
      <tbody>
      <tr class="hover:bg-gray-50">
        <td class="px-4 py-2 border-b" th:text="${latestEntry.tittle}">Title</td>
        <td class="px-4 py-2 border-b break-words max-w-4xl text-justify" th:text="${latestEntry.content}">Content</td>
        <td class="px-4 py-2 border-b" th:text="${#temporals.format(latestEntry.date, 'dd MMM yyyy HH:mm')}">Date</td>

        <!-- Edit Button -->
        <td class="px-4 py-2 border-b text-center">
<<<<<<< HEAD
          <button th:onclick="openEditModal([[${latestEntry.id.toHexString()}]], [[${latestEntry.tittle}]], [[${latestEntry.content}]])"
=======
          <button onclick="openEditModal('[[${latestEntry.id}]]', '[[${latestEntry.tittle}]]', '[[${latestEntry.content}]]')"
>>>>>>> 0ecd5a8 (Initial clean commit)
                  class="bg-blue-500 hover:bg-blue-700 text-white px-2 py-1 rounded text-sm">
            Edit
          </button>
        </td>

        <!-- Delete Button -->
        <td class="px-4 py-2 border-b text-center">
<<<<<<< HEAD
          <form th:action="@{/user/home/journal/delete}" method="post" th:object="${latestEntry}">
            <input type="hidden" th:name="id" th:value="${latestEntry.id}"/>
            <button type="submit" class="bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded">
              Delete
            </button>
          </form>

=======
          <button onclick="deleteEntry('[[${latestEntry.id}]]')"
                  class="bg-red-500 hover:bg-red-700 text-white px-2 py-1 rounded text-sm">
            Delete
          </button>
>>>>>>> 0ecd5a8 (Initial clean commit)
        </td>
      </tr>
      </tbody>
    </table>

  </div>

<<<<<<< HEAD

  <div id="editModal"
       class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
    <div
            class="bg-white p-8 rounded-2xl w-full max-w-3xl md:max-w-2xl lg:max-w-4xl shadow-xl max-h-[85vh] overflow-y-auto">
      <h2 class="text-2xl md:text-3xl font-semibold mb-4 text-center">Edit Journal Entry</h2>

      <form id="editForm" class="space-y-4">
        <input type="hidden" id="editId"/>

        <div>
          <label class="block mb-2 font-medium text-sm">Title</label>
          <input id="editTitle" type="text"
                 class="w-full p-3 border rounded-lg mb-1 text-lg focus:outline-none focus:ring-2 focus:ring-blue-300"/>
        </div>

        <div>
          <label class="block mb-2 font-medium text-sm">Content</label>
          <textarea id="editContent" rows="8"
                    class="w-full p-3 border rounded-lg mb-1 text-base resize-y min-h-[220px] focus:outline-none focus:ring-2 focus:ring-blue-300"></textarea>
        </div>

        <div class="flex justify-end space-x-3 mt-3">
          <button type="button" onclick="closeEditModal()"
                  class="bg-gray-500 hover:bg-gray-700 text-white px-5 py-2 rounded-lg">Cancel
          </button>
          <button type="submit"
                  class="bg-green-600 hover:bg-green-800 text-white px-6 py-2 rounded-lg">Save
          </button>
        </div>
      </form>
    </div>
  </div>

=======
>>>>>>> 0ecd5a8 (Initial clean commit)
  <!-- No Entries Message -->
  <div th:if="${latestEntry == null}" class="text-gray-700 mt-6">
    <p>You haven't added any journal entries yet.</p>
  </div>
</div>
<<<<<<< HEAD
<div id="toast" class="toast"></div>
<script>
  function logout() {
    document.cookie = "jwt=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT; Secure; SameSite=Strict";
    window.location.href = "/";
  }

    // Function to get the JWT from the cookie
function getJwtFromCookie() {
    const name = "jwt=";
    const decodedCookie = decodeURIComponent(document.cookie);
    const ca = decodedCookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) === 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}
// New function to get the CSRF token from the DOM
function getCsrfToken() {
  const tokenInput = document.querySelector('input[name="_csrf"]');
  return tokenInput ? tokenInput.value : '';
}
// openEditModal and closeEditModal functions remain the same
function openEditModal(id, title, content) {
  document.getElementById('editId').value = id;
  document.getElementById('editTitle').value = title;
  document.getElementById('editContent').value = content;
  document.getElementById('editModal').classList.remove('hidden');
}

function closeEditModal() {
  document.getElementById('editModal').classList.add('hidden');
}

// Handle the form submission for editing an entry
document.getElementById('editForm').addEventListener('submit', function(event) {
  event.preventDefault();

  const id = document.getElementById('editId').value;
  const title = document.getElementById('editTitle').value;
  const content = document.getElementById('editContent').value;
  const jwt = getJwtFromCookie(); // Retrieve the JWT
  const csrfToken = getCsrfToken(); // ✅ get CSRF

  fetch(`/user/update/id/${id}`, {
      method: 'PUT',
      headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${jwt}`, // ✅ fixed comma
          'X-CSRF-TOKEN': csrfToken        // ✅ defined correctly
      },
      body: JSON.stringify({
          tittle: title,
          content: content
      })
  })
  .then(response => {
    if (response.ok) {
        showToast("Entry updated successfully!", "success");
        setTimeout(() => location.reload(), 2000); // reload after 2 sec
    } else {
        showToast("Failed to update entry.", "error");
    }
})
.catch(error => {
    console.error("Error:", error);
    showToast("An error occurred while updating the entry.", "error");
})

 .finally(() => {
      closeEditModal();
  });
});



  function deleteEntry(id) {
    if (confirm("Are you sure you want to delete this entry?")) {
        const jwt = getJwtFromCookie();
        const csrfToken = getCsrfToken();
        const currentUrl = window.location.pathname; // Get the current URL path

        // Use a URLSearchParams object to prepare form data
        const formData = new URLSearchParams();
        formData.append('id', id);
        formData.append('redirectTo', currentUrl); // Append the current URL to the form data
        formData.append('_csrf', csrfToken); // Append CSRF token

        fetch(`/user/journal/delete`, {
            method: "POST",
            headers: {
                'Authorization': `Bearer ${jwt}`,
            },
            body: formData
        })
        .then(response => {
            if (response.ok || response.status === 204) {
                showToast("Deleted successfully!", "success");
                setTimeout(() => {
                    window.location.href = currentUrl; // Redirect to the current URL
                }, 1500);
            } else {
                showToast("Failed to delete entry.", "error");
            }
        })
        .catch(err => {
            showToast("Error deleting entry.", "error");
            console.error(err);
        });
    }
  }

  function showToast(message, type) {
    const toast = document.getElementById("toast");
    toast.className = "toast " + type + " show";
    toast.textContent = message;

    setTimeout(() => {
        toast.className = toast.className.replace("show", "");
    }, 3000); // 3 sec hide
}

=======

<script>
  function logout() {
    document.cookie = "jwt=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT; Secure; SameSite=Strict";
    window.location.href = "/welcome";
  }

  function deleteEntry(id) {
        if (confirm("Are you sure you want to delete this entry?")) {
            fetch(`/journal/id/${id}`, {
                method: "DELETE"
            }).then(response => {
                if (response.status === 204) {
                    alert("Deleted successfully!");
                    location.reload();
                } else {
                    alert("Failed to delete entry.");
                }
            });
        }
  }

>>>>>>> 0ecd5a8 (Initial clean commit)
</script>

</body>
</html>
