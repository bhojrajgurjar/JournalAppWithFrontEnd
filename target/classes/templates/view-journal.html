<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Your Journal Entries</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .toast {
    visibility: hidden;
    min-width: 250px;
    margin-left: -125px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 8px;
    padding: 16px;
    position: fixed;
    z-index: 1000;
    left: 50%;
    top: 20px;  /* show at top */
    font-size: 16px;
    opacity: 0;
    transition: opacity 0.5s, top 0.5s;
}

.toast.show {
    visibility: visible;
    opacity: 1;
    top: 40px; /* slide down a little when visible */
}

.toast.success {
    background-color: #28a745; /* Green */
}

.toast.error {
    background-color: #dc3545; /* Red */
}
    </style>


</head>
<body class="bg-gray-100">
<div class="max-w-6xl mx-auto mt-12">
    <div class="bg-white shadow-xl rounded-2xl p-8">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Your Journal Entries</h2>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-800 text-white">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">No.</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Title</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Content</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Update</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Delete</th>
                </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                <tr th:each="entry, stat : ${entries}">
                    <td class="px-6 py-4 whitespace-nowrap font-semibold text-gray-700"
                        th:text="${stat.index + 1}"></td>
                    <td class="px-6 py-4 whitespace-nowrap" th:text="${entry.tittle}"></td>
                    <td class="px-6 py-4 whitespace-normal break-words max-w-4xl text-justify"
                        th:text="${entry.content}"></td>
                    <td class="px-6 py-4 whitespace-nowrap"
                        th:text="${#temporals.format(entry.date, 'dd MMM yyyy HH:mm')}"></td>
                    <td class="px-4 py-2 border-b text-center">
                        <button th:onclick="openEditModal([[${entry.id.toHexString()}]], [[${entry.tittle}]], [[${entry.content}]])"
                                class="bg-blue-500 hover:bg-blue-700 text-white px-2 py-1 rounded text-sm">
                            Edit
                        </button>
                    </td>

                    <!-- Delete Button -->
                    <td class="px-6 py-4">
                        <form th:action="@{/user/journal/delete}" method="post" th:object="${entry}">
                            <input type="hidden" th:name="id" th:value="${entry.id}"/>
                            <input type="hidden" name="redirectTo" th:value="${request.requestURI}" />
                            <button type="submit" class="bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded">
                                Delete
                            </button>
                        </form>

                    </td>
                </tr>
                </tbody>
            </table>
        </div>


        <div id="editModal"
             class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
            <div
                    class="bg-white p-8 rounded-2xl w-full max-w-3xl md:max-w-2xl lg:max-w-4xl shadow-xl max-h-[85vh] overflow-y-auto">
                <h2 class="text-2xl md:text-3xl font-semibold mb-4 text-center">Edit Journal Entry</h2>

                <form id="editForm" class="space-y-4">
                    <input type="hidden" id="editId"/>

                    <div>
                        <label class="block mb-2 font-medium text-sm">Title</label>
                        <input id="editTitle" type="text"
                               class="w-full p-3 border rounded-lg mb-1 text-lg focus:outline-none focus:ring-2 focus:ring-blue-300"/>
                    </div>

                    <div>
                        <label class="block mb-2 font-medium text-sm">Content</label>
                        <textarea id="editContent" rows="8"
                                  class="w-full p-3 border rounded-lg mb-1 text-base resize-y min-h-[220px] focus:outline-none focus:ring-2 focus:ring-blue-300"></textarea>
                    </div>

                    <div class="flex justify-end space-x-3 mt-3">
                        <button type="button" onclick="closeEditModal()"
                                class="bg-gray-500 hover:bg-gray-700 text-white px-5 py-2 rounded-lg">Cancel
                        </button>
                        <button type="submit"
                                class="bg-green-600 hover:bg-green-800 text-white px-6 py-2 rounded-lg">Save
                        </button>
                    </div>
                </form>
            </div>
        </div>


        <div class="flex justify-center mt-6">
            <a th:href="@{/user/home}"
               class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-200">
                Back to Home
            </a>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>


<script>
    // Function to get the JWT from the cookie
function getJwtFromCookie() {
    const name = "jwt=";
    const decodedCookie = decodeURIComponent(document.cookie);
    const ca = decodedCookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) === 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}
// New function to get the CSRF token from the DOM
function getCsrfToken() {
  const tokenInput = document.querySelector('input[name="_csrf"]');
  return tokenInput ? tokenInput.value : '';
}
// openEditModal and closeEditModal functions remain the same
function openEditModal(id, title, content) {
  document.getElementById('editId').value = id;
  document.getElementById('editTitle').value = title;
  document.getElementById('editContent').value = content;
  document.getElementById('editModal').classList.remove('hidden');
}

function closeEditModal() {
  document.getElementById('editModal').classList.add('hidden');
}

// Handle the form submission for editing an entry
document.getElementById('editForm').addEventListener('submit', function(event) {
  event.preventDefault();

  const id = document.getElementById('editId').value;
  const title = document.getElementById('editTitle').value;
  const content = document.getElementById('editContent').value;
  const jwt = getJwtFromCookie(); // Retrieve the JWT
  const csrfToken = getCsrfToken(); // ✅ get CSRF

  fetch(`/user/update/id/${id}`, {
      method: 'PUT',
      headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${jwt}`, // ✅ fixed comma
          'X-CSRF-TOKEN': csrfToken        // ✅ defined correctly
      },
      body: JSON.stringify({
          tittle: title,
          content: content
      })
  })
  .then(response => {
    if (response.ok) {
        showToast("Entry updated successfully!", "success");
        setTimeout(() => location.reload(), 2000); // reload after 2 sec
    } else {
        showToast("Failed to update entry.", "error");
    }
})
.catch(error => {
    console.error("Error:", error);
    showToast("An error occurred while updating the entry.", "error");
})

 .finally(() => {
      closeEditModal();
  });
});



  function deleteEntry(id) {
  const jwt = getJwtFromCookie(); // Retrieve the JWT
  const csrfToken = getCsrfToken(); // ✅ get CSRF
    if (confirm("Are you sure you want to delete this entry?")) {
        fetch(`/user/journal/delete/${id}`, {
            method: "DELETE",
            headers: {
             'Authorization': `Bearer ${jwt}`, // ✅ fixed comma
             'X-CSRF-TOKEN': csrfToken        // ✅ defined correctly
         }, // ✅ sends HttpOnly cookie with JWT
        }).then(response => {
            if (response.status === 204) {
                showToast("Deleted successfully!", "success"); // ✅ green toast
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showToast("Failed to delete entry.", "error"); // ❌ red toast
            }
        }).catch(err => {
            showToast("Error deleting entry.", "error"); // ❌ red toast
            console.error(err);
        });
    }
}

  function showToast(message, type) {
    const toast = document.getElementById("toast");
    toast.className = "toast " + type + " show";
    toast.textContent = message;

    setTimeout(() => {
        toast.className = toast.className.replace("show", "");
    }, 3000); // 3 sec hide
}


</script>
</body>

</html>